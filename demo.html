<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youlytic - YouTube 채널 분석 서비스</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chart-container {
            position: relative;
            height: 300px !important;
            width: 100% !important;
            overflow: hidden;
        }
        .chart-container canvas {
            max-height: 300px !important;
        }
        .video-thumbnail {
            transition: all 0.2s ease;
        }
        .video-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex items-center space-x-2">
                        <i class="fab fa-youtube text-red-600 text-2xl"></i>
                        <span class="text-xl font-bold text-gray-900">Youlytic</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="showApiKeyModal()" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-key mr-1"></i>API 키 설정
                    </button>
                    
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i class="fas fa-chart-line"></i>
                        <span id="quotaStatus">API 키 필요</span>
                    </div>
                    
                    <a href="#" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">로그인</a>
                    <a href="#" class="bg-red-600 text-white hover:bg-red-700 px-4 py-2 rounded-md text-sm font-medium">회원가입</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Hero Section -->
            <div class="text-center py-16">
                <h1 class="text-4xl md:text-6xl font-bold text-gray-900 mb-6">
                    YouTube 채널 분석의 새로운 기준
                </h1>
                <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
                    유튜브 채널의 성과를 깊이 있게 분석하고, 수익 추정부터 콘텐츠 인사이트까지 
                    모든 데이터를 한눈에 확인하세요
                </p>

                <!-- Analysis Form -->
                <div class="max-w-2xl mx-auto">
                    <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="channelInput"
                                placeholder="유튜브 채널 URL, ID 또는 채널명을 입력하세요" 
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-lg">
                            
                            <button onclick="startAnalysis()" 
                                class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:ring-offset-2 text-lg font-medium transition duration-200">
                                분석 시작
                            </button>
                        </div>
                        
                        <div class="text-sm text-gray-500">
                            <span id="apiStatusMessage">YouTube API 키를 설정하면 실제 채널 분석이 가능합니다.</span>
                            <a href="#" onclick="showApiKeyModal()" class="text-red-600 hover:text-red-700">API 키 설정</a>
                        </div>
                    </div>

                    <!-- Quick Search Examples -->
                    <div class="mt-8">
                        <p class="text-sm text-gray-500 mb-4">인기 채널로 바로 체험해보세요:</p>
                        <div class="flex flex-wrap justify-center gap-2">
                            <button onclick="setChannelInput('@MrBeast')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition duration-200">@MrBeast</button>
                            <button onclick="setChannelInput('@PewDiePie')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition duration-200">@PewDiePie</button>
                            <button onclick="setChannelInput('@TEDx')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-700 transition duration-200">@TEDx</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Features Section -->
            <div class="py-16 bg-white rounded-2xl shadow-sm mb-16">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">강력한 분석 기능</h2>
                    <p class="text-gray-600">전문가 수준의 YouTube 채널 분석을 누구나 쉽게</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 px-8">
                    <div class="text-center">
                        <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-chart-line text-red-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">성과 분석</h3>
                        <p class="text-gray-600">조회수, 참여도, 성장률 등 핵심 지표를 종합적으로 분석합니다</p>
                    </div>

                    <div class="text-center">
                        <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-dollar-sign text-green-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">수익 추정</h3>
                        <p class="text-gray-600">다양한 요소를 고려한 정확한 수익 모델로 예상 수익을 계산합니다</p>
                    </div>

                    <div class="text-center">
                        <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-export text-blue-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">리포트 내보내기</h3>
                        <p class="text-gray-600">PDF, CSV 형태로 분석 결과를 저장하고 공유할 수 있습니다</p>
                    </div>
                </div>
            </div>

            <!-- API Key Modal -->
            <div id="apiKeyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900">YouTube API 키 설정</h3>
                            <button onclick="hideApiKeyModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-3">
                                실제 YouTube 데이터를 분석하려면 API 키가 필요합니다.
                            </p>
                            <a href="https://console.developers.google.com" target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-sm underline">
                                Google Console에서 API 키 생성하기 →
                            </a>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">API 키</label>
                            <input type="password" id="apiKeyInput" 
                                placeholder="YouTube Data API v3 키를 입력하세요"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="hideApiKeyModal()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200">
                                취소
                            </button>
                            <button onclick="setApiKey()" 
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">
                                설정
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden bg-white rounded-lg shadow-sm border p-8 mb-8 text-center">
                <div class="animate-spin mx-auto h-12 w-12 border-4 border-red-500 border-t-transparent rounded-full mb-4"></div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">채널 분석 중...</h3>
                <p class="text-gray-600">YouTube API에서 실제 데이터를 가져오고 있습니다.</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-400 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-medium text-red-800">분석 오류</h3>
                        <p id="errorMessage" class="text-red-700 mt-1"></p>
                        <div class="mt-3">
                            <button onclick="showApiKeyModal()" class="text-sm bg-red-100 text-red-800 px-3 py-1 rounded-md hover:bg-red-200">
                                API 키 다시 설정
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Demo Results Section (Hidden by default) -->
            <div id="analysisResults" class="hidden">
                <!-- Header with Channel Info -->
                <div class="bg-white rounded-lg shadow-sm border p-8 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-6">
                            <img id="channelThumbnail" src="" alt="Channel Thumbnail" 
                                class="w-20 h-20 rounded-full object-cover border-2 border-gray-200" 
                                style="display: none;">
                            <div id="channelThumbnailPlaceholder" class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fab fa-youtube text-red-600 text-3xl"></i>
                            </div>
                            
                            <div>
                                <h1 id="channelTitle" class="text-3xl font-bold text-gray-900 mb-2">채널명</h1>
                                <div class="flex items-center space-x-6 text-gray-600">
                                    <span><i class="fas fa-users mr-1"></i> <span id="subscriberCount">-</span> 구독자</span>
                                    <span><i class="fas fa-video mr-1"></i> <span id="videoCount">-</span> 영상</span>
                                    <span><i class="fas fa-eye mr-1"></i> <span id="viewCount">-</span> 조회수</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Actions -->
                        <div class="flex items-center space-x-3">
                            <button onclick="exportToPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                <i class="fas fa-file-pdf mr-2"></i>PDF 다운로드
                            </button>
                            
                            <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                <i class="fas fa-file-csv mr-2"></i>CSV 내보내기
                            </button>
                            
                            <button onclick="shareResults()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-share mr-2"></i>공유
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p id="channelDescription" class="text-gray-700 text-sm leading-relaxed">
                            채널 설명을 불러오는 중...
                        </p>
                    </div>
                </div>

                <!-- Key Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">평균 조회수</h3>
                            <i class="fas fa-eye text-blue-500"></i>
                        </div>
                        <p id="avgViews" class="text-2xl font-bold text-gray-900">계산 중...</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">참여율</h3>
                            <i class="fas fa-heart text-red-500"></i>
                        </div>
                        <p id="engagementRate" class="text-2xl font-bold text-gray-900">계산 중...</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">예상 월 수익</h3>
                            <i class="fas fa-dollar-sign text-green-500"></i>
                        </div>
                        <p id="estimatedEarnings" class="text-2xl font-bold text-gray-900">계산 중...</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-600">분석 영상 수</h3>
                            <i class="fas fa-video text-purple-500"></i>
                        </div>
                        <p id="analyzedVideos" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- View Count Distribution -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">조회수 분포</h3>
                        <div class="chart-container">
                            <canvas id="viewDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Performance Trend -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">성과 트렌드</h3>
                        <div class="chart-container">
                            <canvas id="performanceTrendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Videos Analysis -->
                <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">최근 영상 분석</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">정렬:</span>
                            <select id="sortSelect" onchange="sortVideos()" class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="date-desc">게시일 (최신순)</option>
                                <option value="date-asc">게시일 (오래된순)</option>
                                <option value="views-desc">조회수 (높은순)</option>
                                <option value="views-asc">조회수 (낮은순)</option>
                                <option value="likes-desc">좋아요 (많은순)</option>
                                <option value="likes-asc">좋아요 (적은순)</option>
                                <option value="comments-desc">댓글 (많은순)</option>
                                <option value="comments-asc">댓글 (적은순)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 검색 및 필터 -->
                    <div class="mb-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">제목 검색</label>
                            <input type="text" id="titleFilter" placeholder="제목으로 검색..." 
                                onkeyup="filterVideos()" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">최소 조회수</label>
                            <input type="number" id="minViewsFilter" placeholder="0" 
                                onchange="filterVideos()" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">최소 좋아요</label>
                            <input type="number" id="minLikesFilter" placeholder="0" 
                                onchange="filterVideos()" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">게시일 범위</label>
                            <select id="dateRangeFilter" onchange="filterVideos()" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="">전체</option>
                                <option value="7">최근 7일</option>
                                <option value="30">최근 30일</option>
                                <option value="90">최근 90일</option>
                                <option value="365">최근 1년</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 필터 리셋 버튼 -->
                    <div class="mb-4 flex justify-between items-center">
                        <button onclick="resetFilters()" 
                            class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-200 transition duration-200">
                            <i class="fas fa-undo mr-1"></i>필터 초기화
                        </button>
                        <span id="filteredCount" class="text-sm text-gray-500"></span>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">제목</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600 cursor-pointer hover:bg-gray-50" onclick="sortByColumn('views')">
                                        조회수 <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600 cursor-pointer hover:bg-gray-50" onclick="sortByColumn('likes')">
                                        좋아요 <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600 cursor-pointer hover:bg-gray-50" onclick="sortByColumn('comments')">
                                        댓글 <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600 cursor-pointer hover:bg-gray-50" onclick="sortByColumn('date')">
                                        게시일 <i class="fas fa-sort ml-1"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="videosTable">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        영상 데이터를 불러오는 중...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CTA Section -->
            <div class="text-center py-16 bg-gradient-to-r from-red-500 to-red-600 rounded-2xl text-white">
                <h2 class="text-3xl font-bold mb-4">더 깊은 인사이트가 필요하신가요?</h2>
                <p class="text-xl mb-8 opacity-90">프리미엄 플랜으로 무제한 분석과 고급 기능을 사용하세요</p>
                
                <div class="space-x-4">
                    <a href="#" class="bg-white text-red-600 px-8 py-3 rounded-lg font-medium hover:bg-gray-50 transition duration-200">
                        무료로 시작하기
                    </a>
                    
                    <a href="#" class="border-2 border-white text-white px-8 py-3 rounded-lg font-medium hover:bg-white hover:text-red-600 transition duration-200">
                        프리미엄 요금제 보기
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-16">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <div class="flex items-center justify-center space-x-2 mb-4">
                    <i class="fab fa-youtube text-red-600 text-xl"></i>
                    <span class="text-lg font-bold text-gray-900">Youlytic</span>
                </div>
                <p class="text-gray-600 text-sm">
                    © 2024 Youlytic. YouTube 채널 분석의 새로운 기준.
                </p>
            </div>
        </div>
    </footer>

    <script>
        let API_KEY = '';
        let currentChannelData = null;
        let currentVideosData = [];
        let filteredVideosData = [];
        let viewDistributionChart = null;
        let performanceTrendChart = null;

        // 페이지 로드시 저장된 API 키 복원
        window.onload = function() {
            const savedApiKey = localStorage.getItem('youtube_api_key');
            if (savedApiKey) {
                API_KEY = savedApiKey;
                document.getElementById('quotaStatus').innerHTML = '<i class="fas fa-check text-green-500 mr-1"></i>API 키 설정됨';
                document.getElementById('apiStatusMessage').textContent = '실제 YouTube 채널 분석이 가능합니다!';
            }
        };

        // API 키 모달 표시/숨김
        function showApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('hidden');
        }

        function hideApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('hidden');
            document.getElementById('apiKeyInput').value = '';
        }

        // API 키 설정
        async function setApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                alert('API 키를 입력해주세요.');
                return;
            }
            
            // API 키 유효성 검사
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet&id=UC_x5XG1OV2P6uZZ5FSM9Ttw&key=${apiKey}`);
                if (response.ok) {
                    API_KEY = apiKey;
                    localStorage.setItem('youtube_api_key', apiKey);
                    document.getElementById('quotaStatus').innerHTML = '<i class="fas fa-check text-green-500 mr-1"></i>API 키 설정 완료';
                    document.getElementById('apiStatusMessage').textContent = '실제 YouTube 채널 분석이 가능합니다!';
                    hideApiKeyModal();
                } else {
                    throw new Error('API 키가 유효하지 않습니다.');
                }
            } catch (error) {
                alert('API 키가 유효하지 않습니다. 다시 확인해주세요.');
            }
        }

        // 채널 입력 설정
        function setChannelInput(value) {
            document.getElementById('channelInput').value = value;
        }

        // 분석 시작
        async function startAnalysis() {
            if (!API_KEY) {
                showApiKeyModal();
                return;
            }

            const input = document.getElementById('channelInput').value.trim();
            if (!input) {
                alert('채널 URL, ID 또는 핸들명을 입력해주세요.');
                return;
            }

            await analyzeChannel(input);
        }

        // 채널 분석
        async function analyzeChannel(input) {
            if (!API_KEY) {
                showApiKeyModal();
                return;
            }

            showLoading();
            hideError();
            hideResults();

            try {
                // 1. 채널 ID 추출/검색
                const channelId = await getChannelId(input);
                if (!channelId) {
                    throw new Error('채널을 찾을 수 없습니다.');
                }

                // 2. 채널 정보 가져오기
                const channelData = await getChannelData(channelId);
                
                // 3. 최근 영상 가져오기
                const videosData = await getChannelVideos(channelId);

                // 4. 결과 표시
                displayResults(channelData, videosData);

            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        // 채널 ID 추출/검색
        async function getChannelId(input) {
            // UC로 시작하는 채널 ID인 경우
            if (input.match(/^UC[a-zA-Z0-9_-]{22}$/)) {
                return input;
            }

            // URL에서 채널 ID 추출
            const urlPatterns = [
                /youtube\.com\/channel\/([UC][a-zA-Z0-9_-]{22})/,
                /youtube\.com\/c\/([^/?]+)/,
                /youtube\.com\/user\/([^/?]+)/,
                /youtube\.com\/@([^/?]+)/,
                /@([^/?]+)/
            ];

            for (const pattern of urlPatterns) {
                const match = input.match(pattern);
                if (match) {
                    const identifier = match[1];
                    
                    // 이미 채널 ID인 경우
                    if (identifier.match(/^UC[a-zA-Z0-9_-]{22}$/)) {
                        return identifier;
                    }
                    
                    // 핸들명으로 검색
                    return await searchChannelByHandle(identifier);
                }
            }

            // 직접 검색
            return await searchChannelByName(input);
        }

        // 핸들명으로 채널 검색
        async function searchChannelByHandle(handle) {
            try {
                // forHandle 파라미터 사용 (새로운 방식)
                const response = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=id&forHandle=${handle}&key=${API_KEY}`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    return data.items[0].id;
                }
            } catch (error) {
                console.log('Handle search failed, trying name search');
            }
            
            // forHandle이 실패하면 이름으로 검색
            return await searchChannelByName(handle);
        }

        // 이름으로 채널 검색
        async function searchChannelByName(query) {
            const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${encodeURIComponent(query)}&maxResults=1&key=${API_KEY}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error?.message || 'API 요청 실패');
            }
            
            if (data.items && data.items.length > 0) {
                return data.items[0].snippet.channelId;
            }
            
            return null;
        }

        // 채널 데이터 가져오기
        async function getChannelData(channelId) {
            const response = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings&id=${channelId}&key=${API_KEY}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error?.message || 'API 요청 실패');
            }
            
            if (!data.items || data.items.length === 0) {
                throw new Error('채널 정보를 찾을 수 없습니다.');
            }
            
            return data.items[0];
        }

        // 채널 영상 가져오기
        async function getChannelVideos(channelId, maxResults = 20) {
            // 최근 영상 검색
            const searchResponse = await fetch(`https://www.googleapis.com/youtube/v3/search?part=id&channelId=${channelId}&type=video&order=date&maxResults=${maxResults}&key=${API_KEY}`);
            const searchData = await searchResponse.json();
            
            if (!searchResponse.ok) {
                throw new Error(searchData.error?.message || 'API 요청 실패');
            }
            
            if (!searchData.items || searchData.items.length === 0) {
                return [];
            }
            
            // 영상 ID 추출
            const videoIds = searchData.items.map(item => item.id.videoId).join(',');
            
            // 영상 상세 정보 가져오기
            const videosResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoIds}&key=${API_KEY}`);
            const videosData = await videosResponse.json();
            
            if (!videosResponse.ok) {
                throw new Error(videosData.error?.message || 'API 요청 실패');
            }
            
            return videosData.items || [];
        }

        // 결과 표시
        function displayResults(channelData, videosData) {
            currentChannelData = channelData;
            currentVideosData = videosData;

            // 채널 기본 정보
            document.getElementById('channelTitle').textContent = channelData.snippet.title;
            document.getElementById('channelDescription').textContent = channelData.snippet.description || '설명이 없습니다.';
            
            // 썸네일 설정
            const thumbnail = channelData.snippet.thumbnails?.high?.url || channelData.snippet.thumbnails?.default?.url;
            if (thumbnail) {
                document.getElementById('channelThumbnail').src = thumbnail;
                document.getElementById('channelThumbnail').style.display = 'block';
                document.getElementById('channelThumbnailPlaceholder').style.display = 'none';
            }

            // 통계 정보
            const stats = channelData.statistics;
            document.getElementById('subscriberCount').textContent = formatNumber(stats.subscriberCount);
            document.getElementById('videoCount').textContent = formatNumber(stats.videoCount);
            document.getElementById('viewCount').textContent = formatNumber(stats.viewCount);
            document.getElementById('analyzedVideos').textContent = videosData.length;

            // 분석 데이터 계산
            calculateAnalytics(videosData);

            // 영상 테이블 표시
            displayVideosTable(videosData);

            // 결과 표시
            showResults();

            // 차트 생성 (DOM이 렌더링된 후 실행)
            setTimeout(() => {
                createCharts(videosData);
            }, 100);
        }

        // 분석 데이터 계산
        function calculateAnalytics(videos) {
            if (videos.length === 0) {
                document.getElementById('avgViews').textContent = '데이터 없음';
                document.getElementById('engagementRate').textContent = '데이터 없음';
                document.getElementById('estimatedEarnings').textContent = '데이터 없음';
                return;
            }

            // 평균 조회수 계산
            const totalViews = videos.reduce((sum, video) => sum + parseInt(video.statistics.viewCount || 0), 0);
            const avgViews = Math.round(totalViews / videos.length);
            document.getElementById('avgViews').textContent = formatNumber(avgViews);

            // 참여율 계산 (좋아요 + 댓글) / 조회수 * 100
            const totalEngagement = videos.reduce((sum, video) => {
                const views = parseInt(video.statistics.viewCount || 0);
                const likes = parseInt(video.statistics.likeCount || 0);
                const comments = parseInt(video.statistics.commentCount || 0);
                return sum + (views > 0 ? ((likes + comments) / views) * 100 : 0);
            }, 0);
            const avgEngagement = totalEngagement / videos.length;
            document.getElementById('engagementRate').textContent = avgEngagement.toFixed(2) + '%';

            // 예상 수익 계산 (간단한 추정)
            const estimatedCPM = 2; // $2 CPM 가정
            const monthlyViews = avgViews * 30; // 월 30개 영상 가정
            const monthlyEarnings = (monthlyViews / 1000) * estimatedCPM;
            const minEarnings = Math.round(monthlyEarnings * 0.5);
            const maxEarnings = Math.round(monthlyEarnings * 2);
            document.getElementById('estimatedEarnings').textContent = `$${formatNumber(minEarnings)} - $${formatNumber(maxEarnings)}`;
        }

        // 영상 테이블 표시
        function displayVideosTable(videos) {
            filteredVideosData = [...videos];
            const tbody = document.getElementById('videosTable');
            
            if (videos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">영상 데이터가 없습니다.</td></tr>';
                document.getElementById('filteredCount').textContent = '';
                return;
            }

            renderVideosTable(videos);
            updateFilteredCount(videos.length, videos.length);
        }

        // 실제 테이블 렌더링
        function renderVideosTable(videos) {
            const tbody = document.getElementById('videosTable');
            
            if (videos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">검색 조건에 맞는 영상이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = videos.map(video => {
                const snippet = video.snippet;
                const stats = video.statistics;
                const publishedDate = new Date(snippet.publishedAt).toLocaleDateString('ko-KR');
                const videoUrl = `https://www.youtube.com/watch?v=${video.id}`;
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <div class="flex items-center space-x-4">
                                <div class="relative group cursor-pointer video-thumbnail flex-shrink-0" onclick="openVideo('${video.id}')" title="YouTube에서 영상 보기">
                                    <img src="${snippet.thumbnails?.default?.url || ''}" alt="Thumbnail" 
                                        class="w-16 h-12 object-cover rounded transition-opacity duration-200 group-hover:opacity-75">
                                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                        <div class="bg-red-600 bg-opacity-80 rounded-full p-2">
                                            <i class="fas fa-play text-white text-sm"></i>
                                        </div>
                                    </div>
                                    <div class="absolute bottom-0 right-0 bg-black bg-opacity-70 text-white text-xs px-1 rounded-tl">
                                        <i class="fab fa-youtube"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <a href="${videoUrl}" target="_blank" 
                                       class="font-medium text-gray-900 hover:text-red-600 transition-colors duration-200 block truncate pr-4" 
                                       title="${snippet.title}">
                                        ${snippet.title}
                                    </a>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-external-link-alt mr-1"></i>YouTube에서 보기
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-right py-3 px-4 text-gray-600">${formatNumber(stats.viewCount || 0)}</td>
                        <td class="text-right py-3 px-4 text-gray-600">${formatNumber(stats.likeCount || 0)}</td>
                        <td class="text-right py-3 px-4 text-gray-600">${formatNumber(stats.commentCount || 0)}</td>
                        <td class="text-right py-3 px-4 text-gray-600">${publishedDate}</td>
                    </tr>
                `;
            }).join('');
        }

        // 필터링 함수
        function filterVideos() {
            const titleFilter = document.getElementById('titleFilter').value.toLowerCase();
            const minViews = parseInt(document.getElementById('minViewsFilter').value) || 0;
            const minLikes = parseInt(document.getElementById('minLikesFilter').value) || 0;
            const dateRange = parseInt(document.getElementById('dateRangeFilter').value);
            
            let filtered = [...currentVideosData];

            // 제목 필터
            if (titleFilter) {
                filtered = filtered.filter(video => 
                    video.snippet.title.toLowerCase().includes(titleFilter)
                );
            }

            // 조회수 필터
            if (minViews > 0) {
                filtered = filtered.filter(video => 
                    parseInt(video.statistics.viewCount || 0) >= minViews
                );
            }

            // 좋아요 필터
            if (minLikes > 0) {
                filtered = filtered.filter(video => 
                    parseInt(video.statistics.likeCount || 0) >= minLikes
                );
            }

            // 날짜 범위 필터
            if (dateRange) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - dateRange);
                
                filtered = filtered.filter(video => 
                    new Date(video.snippet.publishedAt) >= cutoffDate
                );
            }

            filteredVideosData = filtered;
            renderVideosTable(filtered);
            updateFilteredCount(filtered.length, currentVideosData.length);
        }

        // 정렬 함수
        function sortVideos() {
            const sortValue = document.getElementById('sortSelect').value;
            const [field, direction] = sortValue.split('-');
            
            sortVideosByField(field, direction);
        }

        function sortByColumn(field) {
            // 현재 정렬 상태를 토글
            const currentSort = document.getElementById('sortSelect').value;
            const [currentField, currentDirection] = currentSort.split('-');
            
            let newDirection = 'desc';
            if (currentField === field && currentDirection === 'desc') {
                newDirection = 'asc';
            }
            
            const newSortValue = `${field}-${newDirection}`;
            document.getElementById('sortSelect').value = newSortValue;
            
            sortVideosByField(field, newDirection);
        }

        function sortVideosByField(field, direction) {
            const videos = [...filteredVideosData];
            
            videos.sort((a, b) => {
                let aVal, bVal;
                
                switch(field) {
                    case 'views':
                        aVal = parseInt(a.statistics.viewCount || 0);
                        bVal = parseInt(b.statistics.viewCount || 0);
                        break;
                    case 'likes':
                        aVal = parseInt(a.statistics.likeCount || 0);
                        bVal = parseInt(b.statistics.likeCount || 0);
                        break;
                    case 'comments':
                        aVal = parseInt(a.statistics.commentCount || 0);
                        bVal = parseInt(b.statistics.commentCount || 0);
                        break;
                    case 'date':
                        aVal = new Date(a.snippet.publishedAt);
                        bVal = new Date(b.snippet.publishedAt);
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
            
            renderVideosTable(videos);
        }

        // 필터 초기화
        function resetFilters() {
            document.getElementById('titleFilter').value = '';
            document.getElementById('minViewsFilter').value = '';
            document.getElementById('minLikesFilter').value = '';
            document.getElementById('dateRangeFilter').value = '';
            document.getElementById('sortSelect').value = 'date-desc';
            
            filteredVideosData = [...currentVideosData];
            renderVideosTable(filteredVideosData);
            updateFilteredCount(filteredVideosData.length, currentVideosData.length);
        }

        // 필터된 개수 업데이트
        function updateFilteredCount(filtered, total) {
            const countElement = document.getElementById('filteredCount');
            if (filtered === total) {
                countElement.textContent = `총 ${total}개 영상`;
            } else {
                countElement.textContent = `${filtered}/${total}개 영상 표시`;
            }
        }

        // 차트 생성
        function createCharts(videos) {
            if (videos.length === 0) return;

            // 기존 차트 파괴
            if (viewDistributionChart) {
                viewDistributionChart.destroy();
                viewDistributionChart = null;
            }
            if (performanceTrendChart) {
                performanceTrendChart.destroy();
                performanceTrendChart = null;
            }

            // 조회수 분포 차트
            const viewRanges = [0, 0, 0, 0, 0]; // 0-10K, 10K-100K, 100K-1M, 1M-10M, 10M+
            videos.forEach(video => {
                const views = parseInt(video.statistics.viewCount || 0);
                if (views >= 10000000) viewRanges[4]++;
                else if (views >= 1000000) viewRanges[3]++;
                else if (views >= 100000) viewRanges[2]++;
                else if (views >= 10000) viewRanges[1]++;
                else viewRanges[0]++;
            });

            const viewDistributionData = {
                labels: ['0-10K', '10K-100K', '100K-1M', '1M-10M', '10M+'],
                datasets: [{
                    label: '영상 수',
                    data: viewRanges,
                    backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'],
                    borderWidth: 0
                }]
            };

            const viewChartCanvas = document.getElementById('viewDistributionChart');
            if (viewChartCanvas) {
                viewDistributionChart = new Chart(viewChartCanvas, {
                    type: 'doughnut',
                    data: viewDistributionData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000
                        },
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        layout: {
                            padding: 10
                        }
                    }
                });
            }

            // 성과 트렌드 차트 (최근 영상들의 조회수)
            const recentVideos = videos.slice(0, 10).reverse();
            const performanceData = {
                labels: recentVideos.map((_, index) => `영상 ${index + 1}`),
                datasets: [{
                    label: '조회수',
                    data: recentVideos.map(video => parseInt(video.statistics.viewCount || 0)),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            };

            const performanceChartCanvas = document.getElementById('performanceTrendChart');
            if (performanceChartCanvas) {
                performanceTrendChart = new Chart(performanceChartCanvas, {
                    type: 'line',
                    data: performanceData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: true
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: true
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value);
                                    },
                                    maxTicksLimit: 6
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10,
                                left: 10,
                                right: 10
                            }
                        },
                        elements: {
                            point: {
                                radius: 4,
                                hoverRadius: 6
                            }
                        }
                    }
                });
            }
        }

        // PDF 내보내기 (한글 지원 개선)
        function exportToPDF() {
            if (!currentChannelData) {
                alert('먼저 채널을 분석해주세요.');
                return;
            }

            // 한글 깨짐 방지를 위해 텍스트 기반 리포트로 생성
            const content = generateReportContent();
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // 안전한 파일명 생성 (특수문자 제거)
            const safeFileName = currentChannelData.snippet.title.replace(/[<>:"/\\|?*]/g, '_');
            a.download = `${safeFileName}_분석리포트.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            // 사용자에게 알림
            setTimeout(() => {
                alert('한글 호환성을 위해 텍스트 파일(.txt)로 다운로드되었습니다.\n내용을 복사하여 워드나 한글 프로그램에서 PDF로 저장하실 수 있습니다.');
            }, 100);
        }

        // CSV 내보내기 (한글 인코딩 개선)
        function exportToCSV() {
            if (!filteredVideosData || filteredVideosData.length === 0) {
                alert('내보낼 영상 데이터가 없습니다.');
                return;
            }

            const csvContent = generateCSVContent();
            
            // 한글 지원을 위한 UTF-8 BOM 추가
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // 안전한 파일명 생성
            const safeFileName = currentChannelData.snippet.title.replace(/[<>:"/\\|?*]/g, '_');
            a.download = `${safeFileName}_영상데이터.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            // 사용자 안내
            setTimeout(() => {
                alert('CSV 파일이 다운로드되었습니다.\n만약 Excel에서 한글이 깨진다면, 파일을 열 때 "UTF-8" 인코딩을 선택해주세요.');
            }, 100);
        }

        // 결과 공유
        function shareResults() {
            if (!currentChannelData) {
                alert('먼저 채널을 분석해주세요.');
                return;
            }

            const shareUrl = `${window.location.origin}${window.location.pathname}`;
            const shareText = `${currentChannelData.snippet.title} 채널을 Youlytic으로 분석했습니다!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Youlytic 분석 결과',
                    text: shareText,
                    url: shareUrl
                });
            } else {
                // 클립보드에 복사
                navigator.clipboard.writeText(`${shareText} ${shareUrl}`).then(() => {
                    alert('링크가 클립보드에 복사되었습니다!');
                });
            }
        }

        // 리포트 내용 생성
        function generateReportContent() {
            const channel = currentChannelData;
            return `
=== YouTube 채널 분석 리포트 ===

채널명: ${channel.snippet.title}
구독자 수: ${formatNumber(channel.statistics.subscriberCount)}명
총 영상 수: ${formatNumber(channel.statistics.videoCount)}개
총 조회수: ${formatNumber(channel.statistics.viewCount)}회

=== 분석 결과 ===
분석 영상 수: ${currentVideosData.length}개
평균 조회수: ${document.getElementById('avgViews').textContent}
참여율: ${document.getElementById('engagementRate').textContent}
예상 월 수익: ${document.getElementById('estimatedEarnings').textContent}

=== 채널 정보 ===
채널 설명:
${channel.snippet.description || '설명이 없습니다.'}

개설일: ${new Date(channel.snippet.publishedAt).toLocaleDateString('ko-KR')}
국가: ${channel.snippet.country || '정보 없음'}

=== 최근 영상 목록 (상위 5개) ===
${filteredVideosData.slice(0, 5).map((video, index) => 
    `${index + 1}. ${video.snippet.title}
   조회수: ${formatNumber(video.statistics.viewCount || 0)}회
   좋아요: ${formatNumber(video.statistics.likeCount || 0)}개
   게시일: ${new Date(video.snippet.publishedAt).toLocaleDateString('ko-KR')}
`).join('\n')}

분석 일시: ${new Date().toLocaleString('ko-KR')}
생성 도구: Youlytic (YouTube 채널 분석 서비스)
            `;
        }

        // CSV 내용 생성 (한글 최적화)
        function generateCSVContent() {
            const header = '영상제목,조회수,좋아요수,댓글수,게시일자,영상URL\n';
            const rows = filteredVideosData.map(video => {
                // 제목에서 쉼표와 따옴표 처리
                const title = `"${video.snippet.title.replace(/"/g, '""').replace(/,/g, '，')}"`;
                const views = video.statistics.viewCount || 0;
                const likes = video.statistics.likeCount || 0;
                const comments = video.statistics.commentCount || 0;
                const date = new Date(video.snippet.publishedAt).toLocaleDateString('ko-KR');
                const videoUrl = `https://www.youtube.com/watch?v=${video.id}`;
                
                return `${title},${views},${likes},${comments},"${date}","${videoUrl}"`;
            }).join('\n');
            
            return header + rows; // BOM은 exportToCSV에서 처리
        }

        // 숫자 포맷팅
        function formatNumber(num) {
            if (!num) return '0';
            const number = parseInt(num);
            if (number >= 1000000000) {
                return (number / 1000000000).toFixed(1) + 'B';
            } else if (number >= 1000000) {
                return (number / 1000000).toFixed(1) + 'M';
            } else if (number >= 1000) {
                return (number / 1000).toFixed(1) + 'K';
            }
            return number.toLocaleString();
        }

        // UI 상태 관리
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorState').classList.add('hidden');
        }

        function showResults() {
            document.getElementById('analysisResults').classList.remove('hidden');
            document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
        }

        function hideResults() {
            document.getElementById('analysisResults').classList.add('hidden');
            
            // 기존 차트 파괴
            if (viewDistributionChart) {
                viewDistributionChart.destroy();
                viewDistributionChart = null;
            }
            if (performanceTrendChart) {
                performanceTrendChart.destroy();
                performanceTrendChart = null;
            }
        }

        // 비디오 열기 함수
        function openVideo(videoId) {
            const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
            window.open(videoUrl, '_blank');
        }
    </script>
</body>
</html>